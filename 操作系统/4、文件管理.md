# 1、文件系统基础

## 1.1、文件的基本概念

### 1.文件的概念

#### 文件

文件是具有文件名的一组相关元素的集合，在文件系统中是一个最大的数据单位，他描述了一个对象集，每个文件都有一个文件名，用户通过文件名来访问文件。

#### 1) 数据项

数据项是文件系统中最低级的数据组织形式，可分为以下两种类型：

- 基本数据项：用于描述一个对象的某种属性的一个值，如姓名、日期或证件号等，是数据中可命名的最小逻辑数据单位，即原子数据。
- 组合数据项：由多个基本数据项组成。

文件可使用的最小单位。

#### 2) 记录

记录是一组相关的数据项的集合，用于描述一个对象在某方面的属性，如一个考生报名记录包括考生姓名、出生日期、报考学校代号、身份证号等一系列域。

文件存取的基本单位。

#### 3) 文件

文件是指由创建者所定义的一组相关信息的集合，逻辑上可分为有结构文件和无结构文件两种。在有结构文件中，文件由一组相似记录组成，如报考某学校的所有考生的报考信息记录，又称记录式文件；而无结构文件则被看成是一个字符流，比如一个二进制文件或字符文件，又称流式文件。

### 2.文件的属性

①名称：文件名称唯一，以容易读取的形式保存。

②标识符：标识文件系统内文件的唯一标签,通常为数字，它是对人不可读的一种内部名称。

③类型：被支持不同类型的文件系统所使用。

④位置：指向设备和设备上文件的指针。

⑤大小：文件当前大小（用字节、字或块表示），也可包含文件允许的最大值。

⑥保护：对文件进行保护的访问控制信息。

⑦时间、日期和用户标识：文件创建、上次修改和上次访问的相关信息，用于保护、 安全和跟踪文件的使用。

### 3.文件的分类

#### 按照用途分类

##### 系统文件

系统构成的文件。大多数系统只允许用户调用执行，而不允许用户去读或修改。

##### 库文件

由系统提供给用户使用的各种标准过程、函数和应用程序文件。这类文件允许用户调用执行，但同样不允许用户修改。

##### 用户文件

用户委托文件系统保存的文件，如源程序、目标程序、原始数据等。这类文件只能由文件所有者使用或所有者授权用户去使用。

#### 按保护级别分类

##### 只读文件

允许所有者和授权者读，不允许修改

##### 读写文件

允许所有者和授权者读写，禁止未核准用户读写

##### 执行文件

允许核准用户调用执行，但不允许对文件进行读写。

##### 不保护文件

不保护文件是指不加任何访问限制的文件。

#### 按信息流向分类

##### 输入文件

对于读卡机或键盘上的文件，只能运行进入，所以这类文件为输入文件。

##### 输出文件

如对于打印机上的文件，只能进行写出，因此这类文件为输出文件。

##### 输入/输出文件

如对于磁盘、磁带上的文件，既可以读又可以写，所以这类文件时输入/输出文件。

#### 按数据形式分类

##### 源文件

由源程序和数据构成的文件。一般由ASCII码和汉字组成。

##### 目标文件

源文件经过编译以后，但尚未链接的目标代码形成的文件。目标文件属于二进制文件。

##### 可执行文件

编译后的目标代码经链接程序链接后形成的可以运行的文件。

### 4.文件的操作

#### 基本的文件操作

- 创建文件
- 删除文件
- 读文件
- 写文件
- 截断文件
- 设置文件的读/写位置

#### 文件的打开和关闭操作

- 打开文件：

系统将文件的属性从外存复制到内存，并设定一个编号返回给用户。以后当用户对该文件进行操作时，只需引用编号向系统提出申请即可。

文件关联信息：

1. 文件指针
2. 文件打开计数
3. 文件磁盘位置
4. 访问权限

- 关闭文件：

系统将打开的文件的编号删除，并销毁其文件控制块。若文件被修改，则需要将修改保存到外存。

## 1.2、文件的逻辑结构和物理结构

文件的逻辑结构是从用户观点出发看到的文件的组织形式。文件的物理结构是从实现观点出发，又称为文件的存储结构，是指文件在外存上的存储组织形式。文件的逻辑结构与存储介质特性无关，但文件的物理结构与存储介质的特性有很大关系。

## 1.3、文件的逻辑结构

### 1.顺序文件

文件中的记录一个接一个地顺序排列，记录可以是定长的或变长的，可以顺序存储或以链表形式存储，在访问时需要顺序搜索文件。

主要优点：

1. 顺序存取时速度较快
2. 若文件为定长记录文件，可以随机访问

缺点：会产生碎片，不利于文件的动态扩充。

### 2.索引文件

![img](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/1-140F1155449139.jpg)

索引结构为一个逻辑文件的信息建立一个索引表。索引表本身是一个定长文件，每个逻辑块是可以变长的，索引表和逻辑文件两者构成了索引文件。

优点：可以随机访问、易于进行文件的增删

缺点：索引表的使用增加了存储空间的开销，索引表的查找策略对文件系统的效率影响很大。

### 3.索引顺序文件

索引顺序文件是顺序文件和索引文件两种形式的结合。

### 4.直接文件和散列（Hash）文件

建立关键词和相应记录物理地址之间的对应关系，这样就可以直接通过关键字的值找到记录的物理地址。

散列文件的存取速度很高，但是会因不同关键字的散列函数值相同而冲突。

## 1.4、目录结构

### 1.文件目录

文件目录：文件说明的集合

目录基本功能：

- 实现按名存取
- 提高检索速度
- 允许文件同名
- 允许文件共享

### 2.文件控制块和索引节点

#### 文件控制块

文件控制块(FCB)是用来存放控制文件需要的各种信息的数据结构，以实现“按名存取”。FCB的有序集合称为文件目录，一个FCB就是一个文件目录项。为了创建一个新文件，系统将分配一个FCB并存放在文件目录中，成为目录项。

主要包含以下信息：

- 基本信息，如文件名、文件的物理位置、文件的逻辑结构、文件的物理结构等。
- 存取控制信息，如文件存取权限等。
- 使用信息，如文件建立时间、修改时间等。

#### 索引节点

在检索目录文件的过程中，只用到了文件名，仅当找到一个目录项（查找文件名与目录项中文件名匹配）时，才需要从该目录项中读出该文件的物理地址。

### 3.单级目录结构

在整个文件系统中只建立一张目录表，每个文件占一个目录项

![img](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/1-140F116245W96.jpg)

单级目录结构实现了 “按名存取”，但是存在查找速度慢、文件不允许重名、不便于文件共享等缺点，而且对于多用户的操作系统显然是不适用的。

### 4.二级目录结构

单级目录很容易造成文件名称的混淆，可以考虑釆用两级方案，将文件目录分成主文件目录(Master File Directory, MFD)和用户文件目录（User File Directory, UFD)两级

![img](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/1-140F1162SXT.jpg)

两级目录结构可以解决多用户之间的文件重名问题，文件系统可以在目录上实现访问限制。但是两级目录结构缺乏灵活性，不能对文件分类。

### 5.树形目录结构

将两级目录结构的层次关系加以推广，就形成了多级目录结构，即树形目录结构

![img](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/1-140F1163124E6.jpg)

树形目录结构可以很方便地对文件进行分类，层次结构清晰，也能够更有效地进行文件的管理和保护。但是，在树形目录中查找一个文件，需要按路径名逐级访问中间结点，这就增加了磁盘访问次数，无疑将影响查询速度。

解决了重名，解决根目录有限的问题。

### 6.图形目录结构

树形目录结构可便于实现文件分类，但不便于实现文件共享，为此在树形目录结构的基础上增加了一些指向同一结点的有向边，使整个目录成为一个有向无环图。引入无环图目录结构是为了<u>实现文件共享</u>

![img](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/1-140F11634005Q.jpg)

无环图目录结构方便实现了文件的共享,但使得系统的管理变得更加复杂。

## 1.5、文件共享

文件共享可以节省大量的外村空间和主存空间，减少输入/输出操作，为用户间的合作提供便利条件。

### 1.共享动机

多用户操作系统的不同用户需要共享一些文件来共同完成任务；网络上不同的计算机之间需要通信，需要远程文件系统的共享功能支持。

### 2.基于索引节点的共享方式（硬链接）

在这种共享方式中引用索引结点，即诸如文件的物理地址及其他的文件属性等信息，不再是放在目录项中，而是放在索引结点中。在文件目录中只设置文件名及指向相应索引结点的指针。在索引结点中还应有一个链接计数count,用于表示链接到本索引结点（亦即文件） 上的用户目录项的数目。当count=2时，表示有两个用户目录项链接到本文件上，或者说是有两个用户共享此文件。

![img](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/1-140F11H004348.jpg)

能够实现文件的异名分享，但当文件被多个用户共享时，文件拥有者不能删除文件。

### 3.利用符号链实现文件共享（软链接）

为使用户B能共享用户A的一个文件F,可以由系统创建一个LINK类型的新文件，也取名为F，并将文件F写入用户B的目录中，以实现用户B的目录与文件F的链接。在新文件中只包含被链接文件F的路径名。这样的链接方法被称为符号链接。

![img](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/1-140F11H331606.jpg)

优点：它能够用于链接世界上任何地方的计算机中的文件此时只需提供该文件所在机器的网络地址以及该机器中的文件路径即可。

缺点：当其他用户访问共享文件时，需要逐层查找目录，开销较大。

## 1.6、文件保护

防止文件收到物理破坏和非法访问。

### 1.访问类型

对文件的保护可以从限制对文件的访问类型中出发。可加以控制的访问类型主要有以下几种：

- 读：从文件中读。
- 写：向文件中写。
- 执行：将文件装入内存并执行。
- 添加：将新信息添加到文件结尾部分。
- 删除：删除文件，释放空间。
- 列表清单：列出文件名和文件属性。

### 2.访问控制

用户划分：

- 拥有者
- 工作组用户
- 其他用户

访问控制：访问控制矩阵、访问控制表、用户权限表、口令和密码。

口令和密码是另外两种访问控制方法。

口令指用户在建立一个文件时提供一个口令，系统为其建立FCB时附上相应口令，同时告诉允许共享该文件的其他用户。用户请求访问时必须提供相应口令。这种方法时间和空间的开销不多，缺点是口令直接存在系统内部，不够安全。

密码指用户对文件进行加密，文件被访问时需要使用密钥。这种方法保密性强，节省了存储空间，不过编码和译码要花费一定时间。

口令和密码都是防止用户文件被他人存取或窃取，并没有控制用户对文件的访问类型。



# 2、文件系统及实现

## 2.1、文件系统的层次结构

文件系统：是指操作系统中与文件管理有关的软件和数据的集合。

![img](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/1-140F11J145964.jpg) 

- 用户接口
- 文件目录系统
- 存取控制验证
- 逻辑文件系统与文件信息缓冲区
- 物理文件系统

## 2.2、目录的实现

### 线性表

最为简单的目录实现方法是使用存储文件名和数据块指针的线性表（数组、链表等）。

优点：实现简单

缺点：查找费时

### 散列表

散列表根据文件名得到一个值，并返回一个指向线性表中元素的指针。

优点：大大缩短了查找目录的时间，插入和删除也简单

缺点：可能冲突

特点：散列表长度固定以及散列函数对表长的依赖性。

## 2.3、文件的实现

文件的实现主要是指文件在存储器上的实现。

### 1.外存分配方式

外存的分配方式是如何为文件分配磁盘块。

簇：几个连续物理块

**文件存储空间的通常以块或簇为单位。**

#### 连续分配

形成顺序文件结构，此时的物理文件为顺序文件。

保证了逻辑文件中的记录顺序与存储器中占用盘块的顺序一致。

优点：查找速度比其他块（需要起始块号和文件大小），物理存储位置的信息也比较简单。

缺点：容易产生碎片，需要定期进行存储空间的紧缩。

#### 链接分配

文件长度需要动态增减以及用户事先不知道文件大小的情况，往往采用连接分配。

- 隐式链接

![img](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/1-140F11RUSK.jpg)

- 显式链接

每个磁盘设置一个链接表又叫FAT，链接文件的指针显式的存储在它里面。

优点：简单（只需起始位置），文件创建与增长容易实现。

缺点：不能随机访问盘块，链接指针会占用一些存储空间，存在可靠性问题。

#### 索引分配

系统为每个文件分配一个索引块，索引块中放索引表，索引表中的每个表项对应分配给该文件的一个物理块。

![img](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/1-140F11S33S57.jpg)

优点：支持直接访问；不会产生外部碎片；文件长度限制解决

缺点：增加了系统空间的开销；存取文件需要访问两次外存，降低文件的存取速度

##### 单级索引分配

每个文件对应的盘块号集中在一起。

##### 两级索引分配

对索引块再建索引。

##### 混合索引分配

- 直接地址
- 一次间接地址
- 二次间接地址

### 2.文件存储空间管理

#### 空闲文件表法

范围：仅适用于连续文件；只有少量空闲文件时效果才好

空闲文件表法为所有空闲文件单独建立一个目录，每个空闲文件在这个目录中占一个表目。

#### 空闲块链表法

空闲块链接表法是将文件存储设备上的所有空闲块链接在一个，形成一条空闲块链，并设置一个头指针指向空闲块链的第一个物理块。

通常采用首次适应算法。

#### 位示图法

为文件存储器建立一张位示图（其实就是一连串二进制的数）1代表已分配，0代表空闲。

位示图的大小由磁盘空间的大小确定。

比较小，可以保存在主存，所以存储空间的分配和回收较快。

需要进行位示图中二进制所在位置与盘块号之间的转换。

#### 成组链接法（UNIX的文件存储空间管理方法）

范围：适用于大型文件系统

- 分配空闲盘块的方法
- 空闲盘块回收的方法



成组链接法占用的空间小，而且超级块不大，可以放在内存中，这样是的大多数分配和回收空闲盘块的工作在内存中进行，提高了效率。

# 3、磁盘组织管理

## 3.1、磁盘结构

### 1.磁盘的物理结构

磁盘是典型的直接存取设备，这种设备允许文件系统直接存取磁盘上的任意物理块。

磁道：磁盘上一系列的同心圆

扇区：磁盘沿径向又分成大小相等的区域

柱面：盘片上与盘片中心有一定距离的所有磁道组成了一个柱面

### 2.磁盘结构中的信息

- 引导控制块
- 分区控制块
- 目录结构
- 文件控制块

### 3.磁盘的访问时间$T_a$

访问时间=寻道时间+旋转延迟+传输时间

#### 寻道时间$T_s$

磁头从当前位置移动到目标磁道位置，所需时间为寻道时间$T_s$

启动磁臂的时间为s

有n条磁道，m为移动一个磁道的时间

$T_s=m*n+s$

#### 旋转延迟$T_r$

旋转磁盘、定位数据所在的扇区所需的时间为旋转延迟$T_r$

设磁盘速度为r

则$T_r=(1/r)/2=1/2r$

#### 传输时间$T_t$

从磁盘上存取数据的时间为传输时间$T_t$

每次读写的字节数b

N为一个磁道上的字节数

$T_t=b/(rN)$

## 3.2、调度算法

### 先来先服务FCSF算法

按照进程请求访问磁盘的先后次序进行调度

特点：合理、简单，但未对寻道进行优化

### 最短寻道算法SSTF

选择与当前磁头所在磁道距离最近的请求作为下一次服务的对象。

性能比FCFS好，但不能保证平均寻道时间短，并且可能会产生饥饿。

### 扫描算法SCAN

在磁头移动方向上选择与当前磁头所在磁道距离最近的请求作为下一次服务的对象。也成为电梯调度算法。具有较好的寻到性能，避免了饥饿现象，但对其两端磁道请求比较不公平。

### 循环扫描算法C-SCAN

规定磁头单向移动。消除对两端磁道请求的不公平。

## 3.3、磁盘管理

### 1.磁盘格式化

低级格式化：在磁盘能存储数据前，他必须分成扇区以便磁盘控制器能进行读和写操作

### 2.引导块

### 3.坏扇区



# 4、错题

- 在利用顺序检索法时，只要路径名的一个分量名未找到，便应停止查找
- 在顺序检索法的查找完成后，即可得到文件的逻辑地址
- 对一个文件的访问，常由用户访问权限和文件属性共同限制
- 系统调用open把文件的信息目录放到打开文件表中
- 在系统内存中设置磁盘缓冲区的主要目的是减少磁盘I/O次数
- 磁盘高速缓存设在内存中
- 