# 1、管理概述

## 1.1、I/O设备的分类与I/O管理的任务

### 1.I/O设备的分类

#### 按设备的使用特性分类

- 存储设备：计算机用来保存信息的设备，如磁盘、磁带
- 人机交互设备：输入输出设备
- 网络通信设备：网络接口，调制解调器

#### 按信息交换单位分类

- 字符设备：处理信息的基本单位是字符
- 块设备：处理信息的基本单位是字符块

#### 按传输速率分类

- 低速设备：传输速率每秒几个字节乃至数百个字节的设备
- 中速设备：传输速率每秒几千个字节乃至数万个字节的设备
- 高速设备：传输速率每秒几十万个字节乃至数十兆个字节的设备

#### 按设备的共享属性分类

- 独占设备。属于临界资源
- 共享设备。允许若干个进程交替的读写信息，同一时刻只允许一个进程运行
- 虚拟设备。通过虚拟技术让一个独占设备在逻辑上被多个进程同时使用的设备

### 2.I/O管理的任务和功能

#### 设备分配

按照设备类型和对应分配算法决定将I/O设备分配给哪一个进程

#### 设备管理

设备处理程序用以实现CPU和设备控制器之间的通信

#### 缓存管理

设置缓冲区的目的是为了缓和CPU与I/O设备速度不匹配的矛盾。缓冲管理程序负责完成缓冲区的分配、释放以及有关的管理工作。

#### 设备独立性

又称设备无关性，是指应用程序独立于物理设备。尽量避免使用实际设备名。

## 1.2、I/O控制方式

![img](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/1-140F2151126349.jpg)

### 1.程序直接控制方式

早起的操作系统，没有中断系统，所以CPU和I/O设备进行通信、传输数据时，由于CPU的速度快于I/O设备，因此CPU需要不断地测试I/O设备。这种控制方式又叫轮询或忙等。

- 优点：工作过程非常简单
- 缺点：CPU的利用率相当低

### 2.中断控制方式

- 优点：有了中断的硬件支持后，CPU和I/O设备间可以并行工作了，大大提高了CPU利用率
- 缺点：每台设备每输入/输出一个数据，都要求中断CPU，这样在一次数据传送过程中的中断次数过多，从而耗费了大量CPU时间。

### 3.DMA控制方式

基本思想：是在外设和内存之间开辟直接的数据交换通路

范围：块设备的数据传输

在DMA控制方式中，设备控制器具有更强的功能，在其控制下，设备和内存之间可以成批地进行数据交换，而不是用CPU干预。

优点：大大减轻了CPU的负担，也使I/O数据传输速率大大提高。

DMA控制方式特点：数据传输的基本单位是数据块；数据是单向传输，且从设备直接送入内存或者相反；仅在传送一个或多个数据块的开始和结束时，才需CPU干预，整块数据的传送是在控制器的控制下完成的。

控制器的功能：

1. 接受和识别命令
2. 数据交换
3. 标识和报告设备的状态
4. 地址识别
5. 数据缓冲

**DMA控制方式与中断控制方式的主要区别是**：

中断控制方式在每个数据传送完成后中断CPU，而DMA控制方式的数据传送则是在所要求的一批数据全部传送结束时才中断CPU；中断控制方式的数据传送是由CPU控制完成，而DMA控制方式是由DMA控制器的控制下完成。

<center>DMA控制器的组成</center>

![](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/1-140F215152VA.jpg)

DMA控制器中设置如下四类寄存器：

1. 命令/状态寄存器(CR)：用于接收从CPU发来的I/O命令或有关控制信息，或设备的状态。
2. 内存地址寄存器(MAR)：在输入时，它存放把数据从设备传送到内存的起始目标地址；在输出时，它存放由内存到设备的内存源地址。
3. 数据寄存器(DR)：用于暂存从设备到内存，或从内存到设备的数据。
4. 数据计数器(DC)：存放本次CPU要读或写的字（节）数。

- 优点：设备和CPU可以并行工作，同时设备与内存的数据交换速度加快，并且不需要CPU干预
- 缺点：数据传送的方向、存放输入数据的内存起始地址及传送数据的长度等都由CPU控制；并且每台设备都需要一个DMA控制器，当设备增加时，不经济。

### 4.通道控制方式

与DMA控制方式相似，以内存为中心，实现设备与内u你直接交换数据的控制方式。

一个通道控制可以做到控制多台设备，进一步减轻了CPU负担。

通道指令类型单一，由于通道硬件比较简单，其所能执行的命令主要局限于与I/O操作有关的指令；通道没有自己的内存，通道执行的通道程序是放在主机的内存中的，换言之，是通道与CPU共享内存。

#### 字节多路通道

单位：字节

用于连接慢速的和中速的设备

通道可以以字节交叉方式轮流为多个外设服务

#### 数组选择通道

用于连接高速设备，但只有一个分配型子通道

通道的利用率低

#### 数组多路通道

含有多个非分配型子通道，因而这种通道既具有很高的数据传输速率，又能获得令人满意的通道利用率。



- 优点：CPU和通道并行操作，通道和通道也能并行操作，从而提高整个系统的效率。
- 缺点：需要更多硬件（通道处理器），因此其成本高。

**DMA与通道控制方式的区别**：

- DMA需要CPU控制数据块的大小、传输的内存，通道控制方式中这些信息都是通道来操作的
- 一个DMA控制器对应一个设备与内存传递数据，一个通道可以多台设备

## 1.3、I/O软件层次结构

基本思想：将设备管理软件组织成一种层次结构。

### 1.层次结构概述

![img](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/1-140F215464T09.png)

### 2.中断处理程序

中断处理是控制输入/输出设备和内存与CPU之间的数据传送的主要方式。

### 3.设备驱动程序

任务：接受来自设备独立性软件的抽象请求，将这些请求转换成设备控制器可以接受的具体命令，再将这些命令发送给设备控制器，并监督这些命令正确执行。

### 4.设备独立性软件

基本任务：实现一般设备都需要的I/O功能，并向用户软件提供一个统一的接口。

### 5.用户层软件

大部分I/O软件都包含在操作系统中，仍有一部分是由与用户程序链接在一起的库函数，甚至运行于内核之外的程序构成的。

# 2、I/O核心子系统

## 2.1、I/O调度概念

I/O调度就是确定-个好的顺序来执行这些I/O请求。应用程序所发布的系统调用的顺序不一定总是最佳选择，所以需要I/o调度来改善系统整体性能，使进程之间公平地共享设备访问，减少I/O完成所需要的平均等待时间。

## 2.2、高速缓存与缓冲区

### 1.缓冲的引入

缓冲的实现方法：

- 采用硬件缓冲器实现，成本高，除了关键位，一般不用
- 在内存划出一块存储区，专门用来临时存放输入/输出数据，这个区域称为缓冲区。

### 2.缓冲的分类

#### 单缓冲

![img](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/1-140F2164603Y5.jpg)

最简单的缓冲形式

![image-20200916150603162](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/image-20200916150603162.png)

处理每块数据的时间=$MAX(B,C)+M$

#### 双缓冲

![img](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/1-140F2164925591.jpg)

![image-20200916150622542](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/image-20200916150622542.png)

处理每块数据的时间=$MAX(B,M+C)$

#### 循环缓冲

![image-20200916150906437](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/image-20200916150906437.png)

![image-20200916150954829](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/image-20200916150954829.png)

#### 缓冲池

![img](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/1-140F21A410961.jpg)

### 3.高速缓存与缓冲区

- 两者存放的数据不同
- 两者的目的不同

## 2.3、设备分配与回收

### 1.设备管理中的数据结构

#### 设备控制表DCT

![image-20200916105452537](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/image-20200916105452537.png)

#### 控制器控制表COCT

![image-20200916105642242](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/image-20200916105642242.png)

#### 通道控制表CHCT

![image-20200916105652857](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/image-20200916105652857.png)

#### 系统设备表SDT

![image-20200916105724131](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/image-20200916105724131.png)

### 2.设备分配策略

考虑设备的独占性、共享性、可虚拟性

#### 设备的使用性质

- 独占设备：采用独享分配。缺点：设备得不到充分利用，可能产生死锁。
- 共享设备：可同时分配给多个进程使用，需注意对这些进程访问该设备的先后次序进行合理的调度。
- 虚拟分配：可虚拟设备是指一台设备在采用虚拟技术后，可变成堕胎逻辑上的虚拟设备，可虚拟设备被认为是可共享的设备，可以同时将它分配给多个进程使用。

#### 设备分配算法

先来先服务算法FCFS

优先高级算法

#### 设备分配的安全性

- 安全分配，保证不产生死锁
- 不安全分配，可能产生死锁

### 3.设备独立性

### 4.设备分配程序

#### 单通路I/O系统的设备分配

#### 多通路I/O系统的设备分配

### 5.设备的回收

## 2.4、假脱机技术

将独占设备改造成共享设备，提高了设备利用率和系统的效率，该技术称为假脱机（SPOOLing）技术。Simultaneous Peripheral Operating On-Line

### 1.SPOOLING系统的组成

#### 输入井和输出井

在磁盘上开辟出的两个存储区域。输入井模拟脱机输入时的磁盘，用于收容I/O设备输 入的数据。输出井模拟脱机输出时的磁盘，用于收容用户程序的输出数据。

![image-20200916151634118](https://gitee.com/HaitoChan/upload-pic-typora/raw/master/null/image-20200916151634118.png)

#### 输入缓冲区和输出缓冲区

在内存中开辟的两个缓冲区。输入缓冲区用于暂存由输入设备送来的数据，以后再传送 到输入井。输出缓冲区用于暂存从输出井送来的数据，以后再传送到输出设备。

#### 输出进程和输出进程

输入进程模拟脱机输入时的外围控制机，将用户要求的数据从输入机通过输入缓冲区再 送到输入井。当CPU需要输入数据时，直接将数据从输入井读入内存。输出进程模拟脱机 输出时的外围控制机，把用户要求输出的数据先从内存送到输出并，待输出设备空闲时，再 将输出井中的数据经过输出缓冲区送到输出设备。

### 2.SPLOOING技术的特点

提高了 I/O的速度；将独占设备改造为共享设备；实现了虚拟设备功能。

# 3、错题

- 缓冲池通常设立在主存/内存种
- 打印机、磁带都属独占设备，磁盘是共享设备
- 缓冲技术解决I/O速度小于CPU处理速度的矛盾
- 设备独立性是指用户程序独立于具体物理设备的一种特性
- 多道程序设计技术是提高处理器利用率的关键技术
- SPOOLing技术是空间换取时间的技术
- 用户程序发出磁盘I/O请求后，系统的正确处理流程是用户程序——>系统调用程序（用户态到核心态）——>设备驱动程序——>中断处理程序
- 管道容量的大小通常为内存上的一页